version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - npm run build
        # Create runtime config with environment variables AFTER build
        - |
          cat > runtime-config.json << EOF
          {
            "CLERK_SECRET_KEY": "$CLERK_SECRET_KEY",
            "DATABASE_URL": "$DATABASE_URL",
            "GEMINI_API_KEY": "$GEMINI_API_KEY",
            "STRIPE_SECRET_KEY": "$STRIPE_SECRET_KEY",
            "STRIPE_WEBHOOK_SECRET": "$STRIPE_WEBHOOK_SECRET",
            "STRIPE_PRO_PRICE_ID": "$STRIPE_PRO_PRICE_ID",
            "UNSPLASH_ACCESS_KEY": "$UNSPLASH_ACCESS_KEY",
            "YOUTUBE_API_KEY": "$YOUTUBE_API_KEY",
            "VAPI_PRIVATE_KEY": "$VAPI_PRIVATE_KEY",
            "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY": "$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY",
            "NEXT_PUBLIC_APP_URL": "$NEXT_PUBLIC_APP_URL",
            "NEXT_PUBLIC_BASE_URL": "$NEXT_PUBLIC_BASE_URL",
            "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY": "$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY",
            "NEXT_PUBLIC_VAPI_API_KEY": "$NEXT_PUBLIC_VAPI_API_KEY"
          }
          EOF
        # Copy to multiple locations for SSR Lambda
        - cp runtime-config.json .next/
        - cp runtime-config.json .next/server/
        - cp runtime-config.json .next/standalone/ 2>/dev/null || true
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
      - '../runtime-config.json'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
